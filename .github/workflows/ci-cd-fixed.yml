---
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '20'
  POSTGRES_VERSION: '15'

jobs:
  # ===============================
  # CONTINUOUS INTEGRATION (CI)
  # ===============================

  # Backend Setup and Validation
  backend-setup:
    name: Backend Setup & Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Python syntax
        run: |
          echo "ğŸ” Validating Python syntax in backend..."
          python -m py_compile backend/addons/*/models/*.py \
            backend/addons/*/*.py || {
            echo "âŒ Python syntax validation failed"
            exit 1
          }
          echo "âœ… Python syntax validation passed"

      - name: Check Odoo configuration
        run: |
          echo "ğŸ” Validating Odoo configuration..."
          if [ -f "backend/odoo.conf" ]; then
            echo "âœ… Odoo configuration file found"
          else
            echo "âš ï¸ Odoo configuration file not found (expected for production)"
          fi

  # Frontend Setup and Build
  frontend-setup:
    name: Frontend Setup & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Lint frontend code
        run: |
          cd frontend
          echo "ğŸ” Running ESLint..."
          npm run lint || {
            echo "âŒ Frontend linting failed"
            exit 1
          }
          echo "âœ… Frontend linting passed"

      - name: Type check frontend
        run: |
          cd frontend
          echo "ğŸ” Running TypeScript type checking..."
          npm run type-check || {
            echo "âŒ TypeScript type checking failed"
            exit 1
          }
          echo "âœ… TypeScript type checking passed"

      - name: Build frontend
        run: |
          cd frontend
          echo "ğŸ—ï¸ Building Next.js application..."
          npm run build || {
            echo "âŒ Frontend build failed"
            exit 1
          }
          echo "âœ… Frontend build completed successfully"

  # Docker Compose Validation
  docker-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Docker Compose configuration
        run: |
          echo "ğŸ” Validating Docker Compose configuration..."
          docker compose config -q || {
            echo "âŒ Docker Compose configuration is invalid"
            exit 1
          }
          echo "âœ… Docker Compose configuration is valid"

      - name: Build Docker images (no cache)
        run: |
          echo "ğŸ—ï¸ Building Docker images..."
          docker compose build --no-cache || {
            echo "âŒ Docker image build failed"
            exit 1
          }
          echo "âœ… All Docker images built successfully"

      - name: Clean up built images
        run: |
          echo "ğŸ§¹ Cleaning up Docker images..."
          docker compose down --rmi all -v || true
          echo "âœ… Cleanup completed"

  # Integration Tests (Placeholder)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Placeholder - Odoo + API Integration Tests
        run: |
          echo "ğŸ”§ Integration Tests Placeholder"
          echo "=================================="
          echo ""
          echo "ğŸ“‹ TODO: Implement integration tests for:"
          echo "   â€¢ Odoo backend API endpoints"
          echo "   â€¢ Frontend API client integration"
          echo "   â€¢ Database connectivity tests"
          echo "   â€¢ Cross-service communication"
          echo "   â€¢ Authentication flow validation"
          echo ""
          echo "âœ… Placeholder step completed (no actual tests run)"
          echo ""
          echo "ğŸ’¡ To implement tests:"
          echo "   1. Add test files in backend/tests/"
          echo "   2. Add test files in frontend/src/__tests__/"
          echo "   3. Configure test databases"
          echo "   4. Set up test environment variables"

  # ===============================
  # CONTINUOUS DEPLOYMENT (CD) - COMMENTED TEMPLATE
  # ===============================

  # CONTABO VPS DEPLOYMENT (COMMENTED OUT)
  # Uncomment and configure the following job to enable deployment to Contabo VPS

  # deploy-contabo:
  #   name: Deploy to Contabo VPS
  #   runs-on: ubuntu-latest
  #   needs: [backend-setup, frontend-setup, docker-validation, integration-tests]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   environment:
  #     name: production
  #     url: https://your-domain.com
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #     - name: Deploy to Contabo VPS
  #       uses: appleboy/ssh-action@v1.1.0
  #       with:
  #         host: ${{ secrets.CONTABO_HOST }}
  #         username: ${{ secrets.CONTABO_USER }}
  #         key: ${{ secrets.CONTABO_SSH_KEY }}
  #         port: 22
  #         script: |
  #           echo "ğŸš€ Starting deployment to Contabo VPS..."
  #           # Navigate to deployment directory
  #           cd /opt/mytriv_erp || {
  #             echo "âŒ Deployment directory not found. Creating..."
  #             sudo mkdir -p /opt/mytriv_erp
  #             cd /opt/mytriv_erp
  #           }
  #           # Backup current deployment (optional)
  #           if [ -d "current" ]; then
  #             echo "ğŸ’¾ Creating backup of current deployment..."
  #             sudo cp -r current backup_$(date +%Y%m%d_%H%M%S) || true
  #           fi
  #           # Pull latest code
  #           echo "ğŸ“¥ Pulling latest code from repository..."
  #           if [ -d ".git" ]; then
  #             git pull origin main || {
  #               echo "âŒ Failed to pull latest code"
  #               exit 1
  #             }
  #           else
  #             echo "âŒ Git repository not initialized"
  #             exit 1
  #           fi
  #           # Stop existing containers
  #           echo "â¹ï¸ Stopping existing containers..."
  #           sudo docker compose down || true
  #           # Pull latest images and start containers
  #           echo "ğŸ³ Pulling and starting containers..."
  #           sudo docker compose pull || true
  #           sudo docker compose up -d --build || {
  #             echo "âŒ Failed to start containers"
  #             exit 1
  #           }
  #           # Wait for services to be healthy
  #           echo "ğŸ¥ Waiting for services to be healthy..."
  #           sleep 30
  #           # Health check
  #           echo "ğŸ” Performing health checks..."
  #           if curl -f http://localhost:3000 >/dev/null 2>&1; then
  #             echo "âœ… Frontend is responding"
  #           else
  #             echo "âŒ Frontend health check failed"
  #             exit 1
  #           fi
  #           if curl -f http://localhost:8069 >/dev/null 2>&1; then
  #             echo "âœ… Backend (Odoo) is responding"
  #           else
  #             echo "âŒ Backend health check failed"
  #             exit 1
  #           fi
  #           echo "ğŸ‰ Deployment completed successfully!"
  #           echo "ğŸŒ Frontend: http://localhost:3000"
  #           echo "ğŸ”§ Backend: http://localhost:8069"

  # ===============================
  # NOTIFICATION AND SUMMARY
  # ===============================

  # Pipeline Summary
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [backend-setup, frontend-setup, docker-validation, integration-tests]
    if: always()
    steps:
      - name: Generate pipeline summary
        run: |
          echo "ğŸ“Š MyTriv ERP CI/CD Pipeline Summary"
          echo "======================================"
          echo ""
          echo "ğŸ”§ **CI Status:**"
          echo "   â€¢ Backend Setup: ${{ needs.backend-setup.result }}"
          echo "   â€¢ Frontend Setup: ${{ needs.frontend-setup.result }}"
          echo "   â€¢ Docker Validation: ${{ needs.docker-validation.result }}"
          echo "   â€¢ Integration Tests: ${{ needs.integration-tests.result }}"
          echo ""
          echo "ğŸ“‹ **Environment:**"
          echo "   â€¢ Python: ${{ env.PYTHON_VERSION }}"
          echo "   â€¢ Node.js: ${{ env.NODE_VERSION }}"
          echo "   â€¢ PostgreSQL: ${{ env.POSTGRES_VERSION }}"
          echo ""
          echo "ğŸš€ **Next Steps:**"
          echo "   â€¢ Uncomment CD section for production deployment"
          echo "   â€¢ Configure deployment secrets in repository settings"
          echo "   â€¢ Set up monitoring and alerting"
          echo ""
          echo "âœ… Pipeline completed!"